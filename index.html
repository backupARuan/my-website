<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿é˜®æªåœ˜è³¼ | é™æ™‚å¥½ç‰©èˆ‡è¨‚å–®æŸ¥è©¢</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            900: '#1e3a8a',
                        },
                        action: {
                            light: '#ffedd5',
                            DEFAULT: '#f97316',
                            hover: '#ea580c',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'hover': '0 10px 25px -5px rgba(59, 130, 246, 0.15)',
                    },
                    animation: {
                        'shimmer': 'shimmer 1.5s infinite linear',
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }

        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        /* éª¨æ¶å±å‹•ç•«èƒŒæ™¯ */
        .skeleton-bg {
            background: #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        .skeleton-bg::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            animation: shimmer 1.5s infinite;
        }

        .product-card {
            transition: all 0.2s ease-out;
            border: 1px solid transparent;
        }
        .product-card:hover {
            transform: translateY(-2px);
            border-color: #bfdbfe;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15);
        }
        .product-card:active {
            transform: scale(0.99);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Modal å‹•ç•« */
        .modal-enter { 
            opacity: 0; 
            transform: scale(0.95); 
        }
        .modal-enter-active { 
            opacity: 1; 
            transform: scale(1); 
            transition: all 0.2s ease-out; 
        }
        .modal-leave-active { 
            opacity: 0; 
            transform: scale(0.95); 
            transition: all 0.2s ease-in; 
        }
    </style>
</head>
<body class="text-slate-600 font-sans min-h-screen pb-10">

    <div class="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-slate-200 shadow-sm">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-brand-500/30">
                    é˜®
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">é˜¿é˜®æªåœ˜è³¼</h1>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="openOrderModal()" class="flex items-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded-full text-xs font-bold transition-colors">
                    ğŸ” <span class="hidden sm:inline">æŸ¥è©¢è¨‚å–®</span>
                </button>
                <div class="hidden sm:block text-xs font-medium text-brand-600 bg-brand-50 px-3 py-1 rounded-full border border-brand-100">
                    åš´é¸å¥½ç‰©
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 py-6">
        
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-slate-800 font-bold text-lg flex items-center gap-2">
                <span class="inline-block w-2 h-6 bg-action-DEFAULT rounded-full"></span>
                ç›®å‰é–‹åœ˜ä¸­
            </h2>
            <span id="item-count" class="text-xs text-slate-400 font-medium">è¼‰å…¥ä¸­...</span>
        </div>

        <div id="product-list" class="space-y-4"></div>

    </div>

    <footer class="text-center py-8 text-slate-400 text-xs">
        <p class="mb-2">Â© 2025 é˜¿é˜®æªåœ˜è³¼</p>
        <p class="text-slate-300 transform scale-90">Designed for Conversion</p>
    </footer>

    <div id="order-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeOrderModal()"></div>
        
        <div class="relative top-20 sm:top-24 mx-auto w-[90%] sm:w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden modal-enter">
            <div class="bg-brand-600 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold text-lg">æˆ‘çš„å¾…å–è²¨æ¸…å–®</h3>
                <button onclick="closeOrderModal()" class="text-white/80 hover:text-white text-xl">&times;</button>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 mb-1">è«‹è¼¸å…¥æ‚¨çš„è¨‚è³¼åç¨±</label>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="customer-name-input" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" 
                            class="w-full sm:flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-500">
                        <button onclick="searchOrder()" class="w-full sm:w-auto bg-brand-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-brand-700 transition">æŸ¥è©¢</button>
                    </div>
                </div>

                <div id="order-result" class="space-y-3 max-h-[50vh] overflow-y-auto">
                    <div class="text-center py-8 text-slate-400 text-sm">
                        è«‹è¼¸å…¥åå­—æŸ¥è©¢<br>å°šæœªé ˜å–çš„å•†å“
                    </div>
                </div>
            </div>
            
            <div id="order-footer" class="bg-slate-50 p-4 border-t border-slate-100 flex justify-between items-center hidden">
                <span class="text-slate-500 text-xs">å°šéœ€æ”¯ä»˜/æ ¸å°</span>
                <span class="text-xl font-bold text-action-DEFAULT" id="total-amount">$0</span>
            </div>
        </div>
    </div>

    <script>
        // API è¨­å®š
        const API_URL = 'https://script.google.com/macros/s/AKfycbzKnBy03ti6FSefXuhsegIYDhg5nspB6s3HXLLRBsQNrP6gYUS20prOoigur_rvSntrhQ/exec';

        // å…¨åŸŸè®Šæ•¸å„²å­˜æ‰€æœ‰è³‡æ–™ (åŒ…å«å•†å“å’Œè¨‚å–®)
        let globalData = { products: [], orders: [] };

        // Modal å…ƒç´ åƒç…§ (å»¶é²åˆå§‹åŒ–)
        let modal, modalBody;

        document.addEventListener('DOMContentLoaded', function () {
            // åˆå§‹åŒ– Modal å…ƒç´ åƒç…§
            modal = document.getElementById('order-modal');
            modalBody = modal.querySelector('.modal-enter');

            const productList = document.getElementById('product-list');
            const itemCount = document.getElementById('item-count');

            // 1. åˆå§‹åŒ–é¡¯ç¤º Skeleton
            renderSkeleton();

            // 2. ç²å–è³‡æ–™
            fetch(API_URL)
                .then(response => response.json())
                .then(data => {
                    // å„²å­˜å®Œæ•´è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸ä¾›è¨‚å–®æŸ¥è©¢ä½¿ç”¨
                    globalData = data;

                    const products = data.products || [];
                    // æ¨¡æ“¬å¾®å°å»¶é²è®“éª¨æ¶å±è½‰æ›æ›´é †æš¢
                    setTimeout(() => renderProducts(products), 500);
                })
                .catch(error => {
                    console.error('Error:', error);
                    productList.innerHTML = `
                        <div class="bg-red-50 border border-red-100 rounded-xl p-8 text-center">
                            <p class="text-red-500 font-medium mb-2">ç„¡æ³•å–å¾—åœ˜è³¼è³‡æ–™</p>
                            <button onclick="location.reload()" class="text-xs text-white bg-red-500 px-4 py-2 rounded-lg hover:bg-red-600 transition">é»æ“Šé‡æ–°æ•´ç†</button>
                        </div>
                    `;
                    itemCount.textContent = "";
                });

            // æ—¥æœŸè§£æè¼”åŠ©å‡½å¼
            function parseSmartDate(dateInput) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const currentYear = today.getFullYear();
                let targetDate;
                let displayStr = "";

                try {
                    if (dateInput && typeof dateInput === 'string') {
                        if (dateInput.includes('-') || dateInput.includes('T')) {
                            targetDate = new Date(dateInput);
                            const m = (targetDate.getMonth() + 1).toString().padStart(2, '0');
                            const d = targetDate.getDate().toString().padStart(2, '0');
                            displayStr = `${m}/${d} æˆªæ­¢`;
                        } else if (dateInput.includes('/')) {
                            const parts = dateInput.split('/');
                            const month = parseInt(parts[0], 10) - 1;
                            const day = parseInt(parts[1], 10);
                            targetDate = new Date(currentYear, month, day);
                            if (today.getMonth() === 11 && month === 0) targetDate.setFullYear(currentYear + 1);
                            displayStr = `${parts[0]}/${parts[1]} æˆªæ­¢`;
                        }
                    }

                    if (!targetDate || isNaN(targetDate.getTime())) {
                        targetDate = new Date(2999, 0, 1);
                        displayStr = "é•·æœŸä¾›æ‡‰";
                    }
                } catch (e) {
                    targetDate = new Date(2999, 0, 1);
                    displayStr = "é•·æœŸä¾›æ‡‰";
                }

                return { obj: targetDate, text: displayStr };
            }

            // æ¸²æŸ“éª¨æ¶å± (Skeleton)
            function renderSkeleton() {
                let html = '';
                for (let i = 0; i < 3; i++) {
                    html += `
                        <div class="bg-white rounded-2xl p-3 border border-slate-100 shadow-sm flex gap-4">
                            <div class="w-24 h-24 sm:w-28 sm:h-28 rounded-xl skeleton-bg flex-shrink-0"></div>
                            <div class="flex-1 flex flex-col justify-between py-2">
                                <div>
                                    <div class="h-4 w-16 skeleton-bg rounded mb-3"></div>
                                    <div class="h-5 w-full skeleton-bg rounded mb-2"></div>
                                    <div class="h-5 w-2/3 skeleton-bg rounded"></div>
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="h-8 w-24 skeleton-bg rounded"></div>
                                    <div class="h-9 w-20 skeleton-bg rounded-lg"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                productList.innerHTML = html;
            }

            // æ¸²æŸ“å•†å“åˆ—è¡¨
            function renderProducts(products) {
                productList.innerHTML = '';

                if (!Array.isArray(products) || products.length === 0) {
                    productList.innerHTML = `<div class="p-10 text-center text-slate-400 bg-white rounded-2xl border border-slate-100">ç›®å‰æ²’æœ‰åœ˜è³¼å•†å“,è«‹ç¨å¾Œå†ä¾†!</div>`;
                    itemCount.textContent = "0 é …å•†å“";
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const activeProducts = products
                    .filter(p => {
                        const dateInfo = parseSmartDate(p.date);
                        const diffDays = Math.ceil((dateInfo.obj - today) / (1000 * 60 * 60 * 24));
                        return diffDays >= 0;
                    })
                    .sort((a, b) => parseSmartDate(a.date).obj - parseSmartDate(b.date).obj);

                itemCount.textContent = `${activeProducts.length} é …å•†å“`;

                if (activeProducts.length === 0) {
                    productList.innerHTML = `<div class="p-10 text-center text-slate-400 bg-white rounded-2xl border border-slate-100">ç›®å‰æ‰€æœ‰åœ˜è³¼çš†å·²çµæŸã€‚</div>`;
                    return;
                }

                activeProducts.forEach((product) => {
                    const priceStr = product.price ? String(product.price).replace('$', '') : '--';
                    const nameStr = product.name || 'ç²¾é¸å¥½ç‰©';
                    const linkStr = product.link || '#';
                    const imageStr = product.image || '';
                    const dateInfo = parseSmartDate(product.date);
                    const diffTime = dateInfo.obj - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    // æ€¥è¿«æ€§æ¨™ç±¤é‚è¼¯
                    let badgeClass = "bg-slate-100 text-slate-600";
                    let badgeIcon = "â°";
                    let badgeText = dateInfo.text;

                    if (diffDays === 0) {
                        badgeClass = "bg-red-50 text-red-600 border border-red-100 animate-pulse";
                        badgeIcon = "ğŸ”¥";
                        badgeText = "æœ€å¾Œä¸€å¤©";
                    } else if (diffDays <= 3) {
                        badgeClass = "bg-orange-50 text-orange-600 border border-orange-100";
                        badgeIcon = "â³";
                        badgeText = `å‰© ${diffDays} å¤©`;
                    }

                    // åœ–ç‰‡è™•ç†ï¼šä¸æ‹‰ä¼¸ï¼Œç½®ä¸­ï¼Œä¿æŒåŸæ¯”ä¾‹
                    const imgHtml = imageStr
                        ? `<img src="${imageStr}" alt="${nameStr}" class="max-w-full max-h-full w-auto h-auto object-contain mix-blend-multiply group-hover:scale-110 transition-transform duration-300" onerror="this.parentNode.innerHTML='<div class=\\'text-2xl\\'>ğŸ›ï¸</div>'">`
                        : `<div class="text-2xl">ğŸ›ï¸</div>`;

                    const rowHtml = `
                        <a href="${linkStr}" target="_blank" class="product-card group block bg-white rounded-2xl p-3 shadow-soft hover:shadow-hover relative overflow-hidden border border-slate-50">
                            <div class="flex gap-4">
                                <div class="w-24 h-24 sm:w-28 sm:h-28 rounded-xl flex-shrink-0 bg-slate-50 border border-slate-100 flex items-center justify-center p-2 relative">
                                    ${imgHtml}
                                    ${diffDays === 0 ? '<div class="absolute bottom-0 left-0 w-full bg-red-600/90 text-white text-[9px] text-center py-0.5 font-bold">å³å°‡æˆªå–®</div>' : ''}
                                </div>
                                
                                <div class="flex-1 flex flex-col justify-between min-w-0 py-1">
                                    <div>
                                        <div class="flex flex-wrap gap-2 mb-1.5">
                                            <div class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium ${badgeClass}">
                                                <span class="mr-1">${badgeIcon}</span> ${badgeText}
                                            </div>
                                        </div>
                                        <h3 class="text-sm sm:text-base font-bold text-slate-800 line-clamp-2 leading-relaxed group-hover:text-brand-600 transition-colors">
                                            ${nameStr}
                                        </h3>
                                    </div>
                                    
                                    <div class="flex items-end justify-between mt-2">
                                        <div class="flex flex-col">
                                            <span class="text-[10px] text-slate-400">åœ˜è³¼åƒ¹</span>
                                            <div class="text-lg sm:text-xl font-bold text-action-DEFAULT font-sans leading-none">
                                                <span class="text-xs font-medium mr-0.5">$</span>${priceStr}
                                            </div>
                                        </div>
                                        
                                        <button class="bg-brand-50 text-brand-600 text-xs font-bold px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg group-hover:bg-brand-600 group-hover:text-white transition-all flex items-center shadow-sm">
                                            å»ä¸‹å–®
                                            <svg class="w-3 h-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </a>
                    `;
                    productList.insertAdjacentHTML('beforeend', rowHtml);
                });
            }
        });

        // === è¨‚å–®æŸ¥è©¢åŠŸèƒ½ ===
        function openOrderModal() {
            if (!modal || !modalBody) return;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBody.style.opacity = '1';
                // é€™è£¡çš„ transform è¨­å®šæ˜¯ç‚ºäº†é…åˆ CSS transition 
                modalBody.style.transform = 'scale(1)';
            }, 10);
            document.getElementById('customer-name-input').focus();
        }

        function closeOrderModal() {
            if (!modal || !modalBody) return;

            modalBody.style.opacity = '0';
            modalBody.style.transform = 'scale(0.95)';
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function searchOrder() {
            const name = document.getElementById('customer-name-input').value.trim();
            const resultDiv = document.getElementById('order-result');
            const footerDiv = document.getElementById('order-footer');
            const totalSpan = document.getElementById('total-amount');

            if (!name) {
                alert('è«‹è¼¸å…¥åå­—');
                return;
            }

            // ç¢ºä¿æœ‰è³‡æ–™
            if (!globalData.orders) {
                alert("ç›®å‰ç„¡æ³•è®€å–è¨‚å–®è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦");
                return;
            }

            // æœå°‹é‚è¼¯ï¼šåå­—åŒ…å«è¼¸å…¥é—œéµå­— ä¸” ç‹€æ…‹ä¸æ˜¯ "å·²å–è²¨"
            const myOrders = globalData.orders.filter(order => {
                const orderName = String(order.customer_name || '');
                const orderStatus = String(order.status || '');
                return orderName.includes(name) && orderStatus !== 'å·²å–è²¨';
            });

            if (myOrders.length === 0) {
                resultDiv.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">ğŸ‰</div>
                        <p class="text-slate-600 font-bold">æ²’æœ‰æœªå–è²¨çš„è¨‚å–®</p>
                        <p class="text-xs text-slate-400 mt-1">æˆ–æ˜¯åå­—è¼¸å…¥æœ‰èª¤ï¼Ÿ</p>
                    </div>
                `;
                footerDiv.classList.add('hidden');
                return;
            }

            // é¡¯ç¤ºåˆ—è¡¨
            let html = '';
            let total = 0;
            myOrders.forEach(order => {
                const price = parseInt(order.total_price) || 0;
                total += price;
                html += `
                    <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <div>
                            <div class="font-bold text-slate-700 text-sm">${order.product_name}</div>
                            <div class="text-xs text-slate-400 mt-0.5">è¦æ ¼: ${order.variant_name}</div>
                            <div class="text-xs text-slate-400 mt-0.5">æ•¸é‡: ${order.quantity}</div>
                            <div class="text-xs text-slate-400 mt-0.5">å”®åƒ¹: ${order.unit_price}</div>
                            <div class="text-xs text-slate-400 mt-0.5">ç‹€æ…‹: ${order.status || 'æœªåˆ°è²¨'}</div>
                        </div>
                        <div class="font-bold text-slate-800">$${price}</div>
                    </div>
                `;
            });

            resultDiv.innerHTML = html;
            totalSpan.textContent = '$' + total;
            footerDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>